import { useEffect, useState } from 'react'
import type { JSX, ChangeEvent } from 'react'
import { supabase } from '../lib/supabase'
import { useSelector } from 'react-redux'
import type { RootState } from '../store/store'
import ConfirmModal from '../components/ConfirmModal'

interface Props {
blogId: string
}

interface Comment {
id: string
content: string
image_url: string | null
author_id: string
created_at: string
profiles: {
full_name: string
avatar_url: string
}[]
}

export default function CommentsSection({ blogId }: Props): JSX.Element {
const user = useSelector((state: RootState) => state.auth.user) as { id: string } | null

const [comments, setComments] = useState<Comment[]>([])
  const [content, setContent] = useState('')
  const [image, setImage] = useState<File | null>(null)
    const [loading, setLoading] = useState(false)

    const [editingId, setEditingId] = useState<string | null>(null)
      const [editContent, setEditContent] = useState('')
      const [editImage, setEditImage] = useState<File | null>(null)

        const [showDeleteModal, setShowDeleteModal] = useState(false)
        const [commentToDelete, setCommentToDelete] = useState<string | null>(null)

          useEffect(() => {
          fetchComments()
          }, [blogId])

          const fetchComments = async () => {
          const { data } = await supabase
          .from('comments')
          .select(`
          id,
          content,
          image_url,
          author_id,
          created_at,
          profiles:profiles!comments_author_id_fkey (
          full_name,
          avatar_url
          )
          `)
          .eq('blog_id', blogId)
          .order('created_at', { ascending: true })

          setComments(data ?? [])
          }

          /* ---------------- CREATE ---------------- */
          const handlePost = async () => {
          if (!user || !content.trim()) return
          setLoading(true)

          let imageUrl: string | null = null

          if (image) {
          const path = `${user.id}/${Date.now()}-${image.name}`
          await supabase.storage.from('comment-images').upload(path, image)
          imageUrl =
          supabase.storage.from('comment-images').getPublicUrl(path).data.publicUrl
          }

          await supabase.from('comments').insert({
          blog_id: blogId,
          content,
          image_url: imageUrl,
          author_id: user.id
          })

          setContent('')
          setImage(null)
          setLoading(false)
          fetchComments()
          }

          /* ---------------- UPDATE ---------------- */
          const handleUpdate = async (comment: Comment) => {
          setLoading(true)

          let updatedImageUrl = comment.image_url

          // Replace / add image
          if (editImage) {
          if (comment.image_url) {
          const oldPath = comment.image_url.split('/comment-images/')[1]
          await supabase.storage.from('comment-images').remove([oldPath])
          }

          const newPath = `${user!.id}/${Date.now()}-${editImage.name}`
          await supabase.storage.from('comment-images').upload(newPath, editImage)
          updatedImageUrl =
          supabase.storage.from('comment-images').getPublicUrl(newPath).data.publicUrl
          }

          await supabase
          .from('comments')
          .update({
          content: editContent,
          image_url: updatedImageUrl
          })
          .eq('id', comment.id)

          setEditingId(null)
          setEditContent('')
          setEditImage(null)
          setLoading(false)
          fetchComments()
          }

          /* ---------------- REMOVE IMAGE ---------------- */
          const handleRemoveImage = async (comment: Comment) => {
          if (!comment.image_url) return

          const path = comment.image_url.split('/comment-images/')[1]
          await supabase.storage.from('comment-images').remove([path])
          await supabase.from('comments').update({ image_url: null }).eq('id', comment.id)

          fetchComments()
          }

          /* ---------------- DELETE ---------------- */
          const confirmDelete = async () => {
          if (!commentToDelete) return
          await supabase.from('comments').delete().eq('id', commentToDelete)
          setShowDeleteModal(false)
          setCommentToDelete(null)
          fetchComments()
          }

          return (
          <div className="mt-10 space-y-4">
            <h2 className="text-xl font-bold">Comments</h2>

            {comments.map(comment => (
            <div key={comment.id} className="bg-white/5 border rounded-xl p-6">
              {editingId === comment.id ? (
              <>
                <textarea className="w-full border p-2 rounded" value={editContent} onChange={e=> setEditContent(e.target.value)}
              />

              {comment.image_url && (
                <img src={comment.image_url} className="mt-2 w-40 rounded" />
              )}

              <input
                type="file"
                accept="image/*"
                className="mt-2"
                onChange={e => setEditImage(e.target.files?.[0] ?? null)}
              />

              {comment.image_url && (
                <button
                  onClick={() => handleRemoveImage(comment)}
                  className="block mt-2 text-xs text-red-500"
                >
                  Remove image
                </button>
              )}

              <div className="flex gap-3 mt-3">
                <button
                  onClick={() => handleUpdate(comment)}
                  className="text-sm text-blue-500"
                >
                  Save
                </button>
                <button
                  onClick={() => setEditingId(null)}
                  className="text-sm text-gray-400"
                >
                  Cancel
                </button>
              </div>
            </>
          ) : (
            <>
              <div className="flex items-center gap-3 mb-2">
                {comment.profiles?.avatar_url ? (
                  <img
                    src={comment.profiles.avatar_url}
                    className="w-8 h-8 rounded-full"
                  />
                ) : (
                  <div className="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-sm">
                    {comment.profiles?.full_name?.[0] ?? '?'}
                  </div>
                )}

                <span className="text-sm font-medium">
                  {comment.profiles?.full_name ?? 'Unknown'}
                </span>
              </div>
              <p>{comment.content}</p>

              {comment.image_url && (
                <img src={comment.image_url} className="mt-2 w-40 rounded" />
              )}

              {user?.id === comment.author_id && (
                <div className="flex gap-3 mt-2">
                  <button
                    onClick={() => {
                      setEditingId(comment.id)
                      setEditContent(comment.content)
                    }}
                    className="text-sm text-blue-500"
                  >
                    Edit
                  </button>
                  <button
                    onClick={() => {
                      setCommentToDelete(comment.id)
                      setShowDeleteModal(true)
                    }}
                    className="text-sm text-red-500"
                  >
                    Delete
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      ))}

      {user && (
        <>
          <textarea
            className="w-full border p-2 rounded"
            placeholder="Write a comment..."
            value={content}
            onChange={e => setContent(e.target.value)}
          />

          <input
            type="file"
            accept="image/*"
            onChange={e => setImage(e.target.files?.[0] ?? null)}
          />

          <button
            onClick={handlePost}
            className="bg-blue-600 text-white px-4 py-2 rounded"
          >
            Post Comment
          </button>
        </>
      )}

      <ConfirmModal
        isOpen={showDeleteModal}
        title="Delete comment?"
        description="This comment will be permanently removed."
        confirmText="Delete"
        onConfirm={confirmDelete}
        onCancel={() => setShowDeleteModal(false)}
      />
    </div>
  )
}