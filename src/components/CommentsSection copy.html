import { useEffect, useState } from 'react'
import type { JSX,ChangeEvent } from 'react'
import { supabase } from '../lib/supabase'
import { useSelector } from 'react-redux'
import type { RootState } from '../store/store'

interface Props {
  blogId: string
}

interface Profile {
  full_name: string
  avatar_url: string | null
}

interface Comment {
  id: string
  content: string
  image_url: string | null
  author_id: string
  created_at: string
  profiles: Profile | null
}

export default function CommentsSection({ blogId }: Props): JSX.Element {
  const user = useSelector((state: RootState) => state.auth.user) as { id: string } | null

  const [comments, setComments] = useState<Comment[]>([])
  const [content, setContent] = useState('')
  const [image, setImage] = useState<File | null>(null)
  const [loading, setLoading] = useState(false)
  const [editingId, setEditingId] = useState<string | null>(null)
  const [editContent, setEditContent] = useState('')

  useEffect(() => {
    fetchComments()
  }, [blogId])

  // Fetch comments from Supabase
  const fetchComments = async () => {
    const { data, error } = await supabase
      .from('comments')
      .select(`
        id,
        content,
        image_url,
        author_id,
        created_at,
        profiles:profiles!comments_author_id_fkey (
          full_name,
          avatar_url
        )
      `)
      .eq('blog_id', blogId)
      .order('created_at', { ascending: true })

    if (error) {
      console.error('FETCH COMMENTS ERROR:', error)
      return
    }

    // Supabase already returns profiles as an object
    setComments(data ?? [])
  }

  // Post a new comment
  const handlePost = async () => {
    if (!user || !content.trim()) return

    setLoading(true)
    let imageUrl: string | null = null

    if (image) {
      const path = `${user.id}/${Date.now()}-${image.name}`
      const { error: uploadError } = await supabase.storage
        .from('comment-images')
        .upload(path, image)

      if (uploadError) {
        console.error('IMAGE UPLOAD ERROR:', uploadError)
        setLoading(false)
        return
      }

      imageUrl = supabase.storage.from('comment-images').getPublicUrl(path).data.publicUrl
    }

    const { error } = await supabase.from('comments').insert({
      blog_id: blogId,
      content,
      image_url: imageUrl,
      author_id: user.id
    })

    if (error) console.error('INSERT COMMENT ERROR:', error)

    setContent('')
    setImage(null)
    setLoading(false)
    fetchComments()
  }

  // Update existing comment
  const handleUpdate = async (commentId: string) => {
    if (!editContent.trim()) return
    setLoading(true)

    const { error } = await supabase
      .from('comments')
      .update({ content: editContent })
      .eq('id', commentId)

    if (error) console.error('UPDATE ERROR:', error)

    setEditingId(null)
    setEditContent('')
    setLoading(false)
    fetchComments()
  }

  // Delete a comment
  const handleDelete = async (id: string) => {
    await supabase.from('comments').delete().eq('id', id)
    fetchComments()
  }

  return (
    <div className="mt-10 space-y-4">
      <h2 className="text-xl font-bold">Comments</h2>

      {comments.map(comment => (
        <div
          key={comment.id}
          className="bg-white/5 border border-white/10 rounded-xl p-6 hover:border-blue-500/40 transition cursor-pointer"
        >
          {editingId === comment.id ? (
            <>
              <textarea
                className="w-full border p-2 rounded"
                value={editContent}
                onChange={e => setEditContent(e.target.value)}
              />
              <div className="flex gap-2 mt-2">
                <button
                  onClick={() => handleUpdate(comment.id)}
                  className="text-sm text-blue-600"
                >
                  Save
                </button>
                <button
                  onClick={() => {
                    setEditingId(null)
                    setEditContent('')
                  }}
                  className="text-sm text-gray-500"
                >
                  Cancel
                </button>
              </div>
            </>
          ) : (
            <>
              <div className="flex items-center gap-3 mb-2">
                {comment.profiles?.avatar_url ? (
                  <img
                    src={comment.profiles.avatar_url}
                    className="w-8 h-8 rounded-full"
                  />
                ) : (
                  <div className="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-sm">
                    {comment.profiles?.full_name?.[0] ?? '?'}
                  </div>
                )}

                <span className="text-sm font-medium">
                  {comment.profiles?.full_name ?? 'Unknown'}
                </span>
              </div>

              <p>{comment.content}</p>

              {comment.image_url && (
                <img src={comment.image_url} className="mt-2 w-40 rounded" />
              )}

              {user?.id === comment.author_id && (
                <div className="flex gap-3 mt-2">
                  <button
                    onClick={() => {
                      setEditingId(comment.id)
                      setEditContent(comment.content)
                    }}
                    className="text-sm text-blue-600"
                  >
                    Edit
                  </button>
                  <button
                    onClick={() => handleDelete(comment.id)}
                    className="text-sm text-red-600"
                  >
                    Delete
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      ))}

      {user && (
        <>
          <textarea
            className="w-full border p-2 rounded"
            placeholder="Write a comment..."
            value={content}
            onChange={(e: ChangeEvent<HTMLTextAreaElement>) =>
              setContent(e.target.value)
            }
          />

          <input
            type="file"
            accept="image/*"
            onChange={(e: ChangeEvent<HTMLInputElement>) =>
              setImage(e.target.files?.[0] ?? null)
            }
          />

          <button
            onClick={handlePost}
            disabled={loading}
            className="bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50"
          >
            {loading ? 'Posting...' : 'Post Comment'}
          </button>
        </>
      )}
    </div>
  )
}
